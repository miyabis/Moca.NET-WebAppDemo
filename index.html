<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Moca.net Web App Demo by miyabis</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Moca.net Web App Demo</h1>
        <p class="header"></p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/miyabis/Moca.NET-WebAppDemo/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/miyabis/Moca.NET-WebAppDemo/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/miyabis/Moca.NET-WebAppDemo">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/miyabis">miyabis</a></p>


      </header>
      <section>
        <h1>
<a id="mocanet-web-form-app-demo" class="anchor" href="#mocanet-web-form-app-demo" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Moca.NET Web Form App Demo</h1>

<p>sample application that uses a moca.net</p>

<p><a href="https://github.com/mocanet/MocaCore">Moca.NET Framework</a></p>

<h2>
<a id="環境構築" class="anchor" href="#%E7%92%B0%E5%A2%83%E6%A7%8B%E7%AF%89" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>環境構築</h2>

<h3>
<a id="拡張機能のインストール" class="anchor" href="#%E6%8B%A1%E5%BC%B5%E6%A9%9F%E8%83%BD%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>拡張機能のインストール</h3>

<ul>
<li>
<a href="https://visualstudiogallery.msdn.microsoft.com/7735e52f-74f2-4ac7-8172-11cde77e6290">Moca.NET Templates</a> (<a href="https://visualstudiogallery.msdn.microsoft.com/f97a7486-560b-425a-aa05-528dd397f5ba">v2010</a>)</li>
<li>
<a href="https://visualstudiogallery.msdn.microsoft.com/96efa364-a9d3-4352-85fc-c5d117abca7f">Moca.NET Code Snippet</a> (<a href="https://visualstudiogallery.msdn.microsoft.com/ef40c12b-d48e-45e5-9e18-12726b9ac1ee">v2010</a>)</li>
</ul>

<h3>
<a id="サンプルのインストール" class="anchor" href="#%E3%82%B5%E3%83%B3%E3%83%97%E3%83%AB%E3%81%AE%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>サンプルのインストール</h3>

<p>サンプル ギャラリーから当サンプルをインストールします。
<img src="https://raw.githubusercontent.com/miyabis/Moca.NET-WebAppDemo/master/Images/SampleInstall.png" alt="サンプルのインストール"></p>

<p>サンプルのプロジェクトを新しく作成します。
<img src="https://raw.githubusercontent.com/miyabis/Moca.NET-WebAppDemo/master/Images/SampleCreate.png" alt="サンプルのプロジェクト作成"></p>

<h1>
<a id="新規に作成するには" class="anchor" href="#%E6%96%B0%E8%A6%8F%E3%81%AB%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B%E3%81%AB%E3%81%AF" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>新規に作成するには</h1>

<h2>
<a id="web-form-プロジェクト作成" class="anchor" href="#web-form-%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E4%BD%9C%E6%88%90" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Web Form プロジェクト作成</h2>

<p>通常通りに新規にプロジェクトを作成してください。<br>
※VB.NET の場合は、Moca.NETのプロジェクトテンプレートを使うこともできます。</p>

<h4>
<a id="ライブラリの追加" class="anchor" href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E8%BF%BD%E5%8A%A0" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>ライブラリの追加</h4>

<p>Nuget にて Moca のライブラリを追加します。  </p>

<ul>
<li>Web の場合、『<a href="https://www.nuget.org/packages/Moca.NETWebFormsProject/">Moca.NET Project Template Web Form</a>』</li>
</ul>

<p>※Moca.NETのプロジェクトテンプレートを使ったときは既に追加されているため不要です。</p>

<h4>
<a id="ライブラリの更新" class="anchor" href="#%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%81%AE%E6%9B%B4%E6%96%B0" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>ライブラリの更新</h4>

<p>追加した Moca のライブラリを最新にします。</p>

<h4>
<a id="log4net-を使う場合" class="anchor" href="#log4net-%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>log4net を使う場合</h4>

<p>WebConfigTransformAssemblyInfo.(vb or cs) ファイルの log4net 部分のアセンブリ属性を有効にする。</p>

<p>C# : Properties\WebConfigTransformAssemblyInfo.cs</p>

<pre><code>[assembly: log4net.Config.XmlConfigurator(ConfigFile=@"log4net.config", Watch=true)]
</code></pre>

<p>VB : My Project\WebConfigTransformAssemblyInfo.vb</p>

<pre><code>&lt;Assembly: log4net.Config.XmlConfigurator(ConfigFile:="log4net.config", Watch:=True)&gt;
</code></pre>

<h4>
<a id="設定ファイルの暗号化" class="anchor" href="#%E8%A8%AD%E5%AE%9A%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB%E3%81%AE%E6%9A%97%E5%8F%B7%E5%8C%96" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>設定ファイルの暗号化</h4>

<p>WebConfigTransformAssemblyInfo.(vb or cs) ファイルの Moca 部分のアセンブリ属性を有効にし、暗号種別、暗号化（複合化）したいセクション名を入力する。</p>

<p>C# :</p>

<pre><code>[assembly: Moca.Configuration.SectionProtection(Moca.Configuration.ProtectionProviderType.DPAPI, "Section Name")]
</code></pre>

<p>VB :</p>

<pre><code>&lt;Assembly: Moca.Configuration.SectionProtection(Moca.Configuration.ProtectionProviderType.DPAPI, "Section Name")&gt;
</code></pre>

<p>プログラムの起動時に次のメソッドを実行する。
ここまで手順通りであれば、MocaAssemblyInfo.(vb or cs) ファイルにて WebActivator を利用して実行するようになっています。</p>

<pre><code>Moca.Configuration.SectionProtector.Protect()
</code></pre>

<h4>
<a id="初期化終了処理" class="anchor" href="#%E5%88%9D%E6%9C%9F%E5%8C%96%E7%B5%82%E4%BA%86%E5%87%A6%E7%90%86" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>初期化・終了処理</h4>

<p>WebActivator を利用して初期化・終了処理を行っています。
アセンブリ属性は MocaAssemblyInfo.(vb or cs) ファイルに定義してあります。</p>

<h4>
<a id="web-フォーム作成" class="anchor" href="#web-%E3%83%95%E3%82%A9%E3%83%BC%E3%83%A0%E4%BD%9C%E6%88%90" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Web フォーム作成</h4>

<p>Moca.NET テンプレートの 「Web フォーム」から作成してください。<br>
※ フォームの継承先が Page から Moca.Web.UI.MocaPage に変更されて作成されます。
なお、マスターページ、ユーザーコントロール、APIコントローラークラスも同様に Moca のクラスを継承するように作成されます。</p>

<h4>
<a id="セッションを使う場合" class="anchor" href="#%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>セッションを使う場合</h4>

<p>Moca.NET テンプレートの 「Web Session インタフェース」を使って作成します。
インタフェースへセッション変数名でプロパティを定義します。
セッションを利用するページで Protected 以上でインタフェースを使ったフィールドを定義します。<br>
※ 実装クラスは不要です。Moca.NET で実行時に自動的にセッションを割り当てます。</p>

<h4>
<a id="クッキーを使う場合" class="anchor" href="#%E3%82%AF%E3%83%83%E3%82%AD%E3%83%BC%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>クッキーを使う場合</h4>

<p>Moca.NET テンプレートの 「Web Cookie インタフェース」を使って作成します。<br>
インタフェースには HttpCookie を返す読み取り専用プロパティを定義し、インタフェースを使う時はスニペットの ICookie を使ってフィールドを定義します。</p>

<h4>
<a id="クエリー文字列を使う場合" class="anchor" href="#%E3%82%AF%E3%82%A8%E3%83%AA%E3%83%BC%E6%96%87%E5%AD%97%E5%88%97%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>クエリー文字列を使う場合</h4>

<p>クエリー文字列を取得するためのインタフェースを定義します。  </p>

<pre><code>&lt;Moca.Web.Attr.QueryString()&gt;
Public Interface IQueryStrings

    &lt;Moca.Web.Attr.QueryStringName("c")&gt;
    Property Count As String

End Interface
</code></pre>

<h4>
<a id="ビューステートを使う場合" class="anchor" href="#%E3%83%93%E3%83%A5%E3%83%BC%E3%82%B9%E3%83%86%E3%83%BC%E3%83%88%E3%82%92%E4%BD%BF%E3%81%86%E5%A0%B4%E5%90%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>ビューステートを使う場合</h4>

<p>ビューステートを使うページで IViewState スニペットを使ってインタフェースを定義します。
ビューステートを利用するページで Protected 以上でインタフェースを使ったフィールドを定義します。  </p>

<h2>
<a id="データベースアクセス" class="anchor" href="#%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>データベースアクセス</h2>

<p>Moca.NET では、データベースアクセスクラスを作成してアクセスします。</p>

<h3>
<a id="エンティティ-作成" class="anchor" href="#%E3%82%A8%E3%83%B3%E3%83%86%E3%82%A3%E3%83%86%E3%82%A3-%E4%BD%9C%E6%88%90" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>エンティティ 作成</h3>

<p>Moca.NET テンプレートの「Entity クラス」で作成します。<br>
ウィザード形式で、接続先DBを選択しSQLステートメントを実行することでクラスを作成します。</p>

<h3>
<a id="dao-作成" class="anchor" href="#dao-%E4%BD%9C%E6%88%90" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dao 作成</h3>

<p>Moca.NET テンプレートの「Dao クラス」で作成でき、インタフェースと実装クラスの構成で作成されます。
接続先はインタフェース毎の指定となり、Dao 属性の引数に設定ファイル（Config）の connectionStrings キーを指定することでインタフェース内のメソッドがデータベースへアクセスできるようになります。
メソッド内のコードはスニペット（DAODelete、DAOInsert、DAOSelect、DAOStoredPrepare、DAOStoredSelect、DAOStoredUpd、DAOUpdate）を使ってください。</p>

<h3>
<a id="トランザクション処理" class="anchor" href="#%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E5%87%A6%E7%90%86" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>トランザクション処理</h3>

<p>更新系のSQLステートメントを実行するときは、インタフェースのメソッドへ Transaction 属性を付けてください。
この属性を付けると、トランザクションの開始、コミット、例外発生時のロールバックを自動で行います。
TransactionScope（MSDTC）を使うときは設定ファイルの moca セクションの transaction タグの Type 属性へ scope を指定し、使わないときは local を指定してください。</p>

<h3>
<a id="dao-を使う" class="anchor" href="#dao-%E3%82%92%E4%BD%BF%E3%81%86" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Dao を使う</h3>

<p>クラスのフィールドとして Protected 以上で定義してください。
インスタンス化はライブラリで自動で行うので New しないでください。</p>

<h2>
<a id="アスペクト" class="anchor" href="#%E3%82%A2%E3%82%B9%E3%83%9A%E3%82%AF%E3%83%88" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>アスペクト</h2>

<p>Moca.NET では、アスペクト属性を使ってインターセプターを割り込ませることができます。
アスペクト属性を付けたメソッドを持つクラスは、使う側のクラスをインジェクト（Moca.Di.MocaInjector.Inject()）してください。
インターセプタークラスは「AOP メソッドインターセプタークラス」テンプレートを使って作成します。
DaoクラスでDBをメインに使ったインターセプターは「AOP Daoインターセプタークラス」テンプレートを使用してください。</p>

<h2>
<a id="注意点" class="anchor" href="#%E6%B3%A8%E6%84%8F%E7%82%B9" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>注意点</h2>

<p>Moca.NET では透過プロキシを使っています。Visual Studio 2015で透過型プロキシの値をウォッチしても現状だと見ることができません。下記を参考にオプションの設定を変更することで見ることができるようになります。</p>

<p><a href="https://blogs.msdn.microsoft.com/jpvsblog/2016/03/28/visual-studio-2015-transparentproxy/">Visual Studio 2015で透過型プロキシのランタイム型をウォッチする際の注意点について</a></p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>
